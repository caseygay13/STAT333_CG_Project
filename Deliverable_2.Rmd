---
title: "Deliverable_2"
author: "Tom Holley & Casey Gay"
date: "2025-11-11"
output:
  pdf_document: default
  html_document: default
---


```{r}
# STAT 333 - Deliverable 2: Descriptive Statistical Analysis
# NBA Team Winning Percentage by Game Performance Statistics
# Casey Gay, Tom Holley - November 14, 2024


library(tidyverse)
library(tinytex)
library(corrplot)
library(GGally)
library(car)
library(MASS)
library(knitr)
library(gridExtra)


nba_data <- read.csv("nba_data(in).csv")

nba_data$Season <- as.factor(nba_data$Season)
nba_data$Team <- as.factor(nba_data$Team)

colnames(nba_data)[7] <- "FG_PCT"
colnames(nba_data)[10] <- "X3P_PCT"
colnames(nba_data)[13] <- "X2P_PCT"
colnames(nba_data)[16] <- "FT_PCT"
colnames(nba_data)[28] <- "WIN_PCT"

# DESCRIPTIVE STATISTICS


# Summary by season
season_summary <- nba_data %>%
  group_by(Season) %>% 
  summarize(
    n = n(),
    mean_WIN_PCT = mean(WIN_PCT),
    sd_WIN_PCT = mean(WIN_PCT),
    across(c(FG, FGA, FG_PCT, X3P, X3PA, X3P_PCT, X2P, X2PA, X2P_PCT, FT, FTA, FT_PCT, ORB, DRB, TRB, AST, STL, BLK, TOV, PF, PTS),
           mean,
           .names = "mean_{.col}")
     )

print(season_summary) #(table displays all possible variables being considered)


# VISUALIZATION

# Distribution of Winning Percentage
p1 <- ggplot(nba_data, aes(x = WIN_PCT)) +
  geom_histogram(bins = 20, fill = "steelblue", color = "black", alpha = 0.7) +
  geom_vline(xintercept = 0.5, linetype = "dashed", color = "red", linewidth = 1) +
  labs(title = "Distribution of Team Winning Percentage (2018-2024)",
       x = "Winning Percentage", y = "Frequency") +
  theme_minimal()

# Winning percentage by season
p2 <- ggplot(nba_data, aes(x = Season, y = WIN_PCT)) +
  geom_boxplot(fill = "lightblue", alpha = 0.7) +
  geom_hline(yintercept = 0.5, linetype = "dashed", color = "red") +
  labs(title = "Winning Percentage Distribution by Season",
       x = "Season", y = "Winning Percentage") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# 3-Point Attempt Trend Over Time
p3 <- ggplot(nba_data, aes(x = Season, y = X3PA, group = 1)) +
  geom_boxplot(fill = "orange", alpha = 0.7) +
  stat_summary(fun = mean, geom = "line", aes(group = 1), 
               color = "darkred", size = 1.5) +
  stat_summary(fun = mean, geom = "point", color = "darkred", size = 3) +
  labs(title = "Evolution of 3-Point Attempts (2018-2024)",
       subtitle = "Line shows mean across teams",
       x = "Season", y = "3-Point Attempts per Game") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# Save plots
ggsave("win_pct_distribution.png", p1, width = 8, height = 6)
ggsave("win_pct_by_season.png", p2, width = 8, height = 6)
ggsave("3pa_trend.png", p3, width = 8, height = 6)


# CORRELATION ANALYSIS

# Select numeric variables for correlation
cor_vars <- nba_data %>%
  dplyr::select(FG, FGA, FG_PCT, X3P, X3PA, X3P_PCT, X2P, X2PA, X2P_PCT, FT, FTA, FT_PCT, ORB, DRB, TRB, AST, STL, BLK, TOV, PF, PTS, WIN_PCT)
 
cor_mat <- cor(cor_vars, use = "complete.obs")
 
png("correlation_heatmap.png", width = 10, height = 10, units = "in", res = 300)
corrplot(cor_mat, method = "color", type = "upper", 
         tl.col = "black", tl.srt = 45,
         addCoef.col = "black", number.cex = 0.7,
         title = "Correlation Matrix: Performance Stats vs Winning Percentage",
         mar = c(0,0,2,0))
dev.off()

# Correlations with WIN_PCT (sorted)
win_correlations <- cor_mat[,"WIN_PCT"] %>%
  sort(decreasing = TRUE)
print("Correlations with Winning Percentage:")
print(round(win_correlations, 3))


#KEY BIVARIATE RELATIONSHIPS


# Top 4 correlated variables with WIN_PCT
top_vars <- names(sort(abs(cor_mat[,"WIN_PCT"]), decreasing = TRUE)[2:5])

# Our 6 chosen covariates
our_vars <- names(sort((cor_mat[,"WIN_PCT"]), decreasing = TRUE) [c(2, 11, 16, 19, 21, 22)])

# Create scatterplots for top predictors
plot_list <- lapply(our_vars, function(var) {
  ggplot(nba_data, aes_string(x = var, y = "WIN_PCT")) +
    geom_point(alpha = 0.6, color = "steelblue") +
    geom_smooth(method = "lm", color = "red", se = TRUE) +
    labs(title = paste("WIN_PCT vs", var),
         x = var, y = "Winning Percentage") +
    theme_minimal()
})
plot_list

# Arrange plots
grid.arrange(grobs = plot_list, ncol = 2)

# Save
ggsave("top_predictors_scatterplots.png", 
       arrangeGrob(grobs = plot_list, ncol = 2),
       width = 12, height = 10)


# 7. INITIAL REGRESSION MODELS


# Model 1: Full model with all predictors
full_model <- lm(WIN_PCT ~ FG+FGA+FG_PCT+X3P+X3PA+X3P_PCT+X2P+X2PA+X2P_PCT+FT+FTA+FT_PCT+ ORB+DRB+TRB+AST+STL+BLK+TOV+PF+PTS,
                 data = nba_data)

summary(full_model)

# Check multicollinearity
vif_values <- vif(full_model)
print("VIF Values for Full Model:")
print(sort(vif_values, decreasing = TRUE))

# Identify problematic variables (VIF > 10)
high_vif <- vif_values[vif_values > 10]
print("Variables with VIF > 10:")
print(high_vif)
#There are very obvious issues with collinearity -> explore which variables need to be removed

# Model 2: Reduced model removing highly collinear variables
# Removed variables known to be direct functions of other variables (FG, FGA, FG_PCT, PTS, X2P, X3P, FT, TRB)
reduced_model <- lm(WIN_PCT ~ X2PA+X2P_PCT+X3PA+X3P_PCT+FTA+FT_PCT+ORB+DRB+AST+TOV+PF+STL+BLK,
                    data = nba_data)

summary(reduced_model)
vif(reduced_model)
#There are still potential concerns around collinearity for a couple variables, but it looks much better overall, and all VIFs are under 10 (not a hard rule, but a solid reference point)

# Model 3: Alternative reduced model, with different collinearity removals
# Points are capturing the effect of the other shooting variables
reduced_model2 <- lm(WIN_PCT ~ ORB+TRB+STL+TOV+PF+PTS, data=nba_data)
summary(reduced_model2)
vif(reduced_model2)
#This is the best model so far

# Model 4: Stepwise selection (both directions)
stepwise_model <- stepAIC(full_model, direction = "both", trace = FALSE)
summary(stepwise_model)
#This model includes too many variables, many of which are not significant, which complicates the interpretation of their true effects. The AIC of the reduced_model 2 is also preferred. Thus, this is not our preferred model.

# Model 5: Based on literature (Cabarkapa et al., Chatterjee et al.)
literature_model <- lm(WIN_PCT ~ FG_PCT + X3P_PCT + FT_PCT + DRB + TOV,
                       data = nba_data)
summary(literature_model)
#This model is not found to be effective for our question.


# 8. MODEL COMPARISON


# Compare models
model_comparison <- data.frame(
  Model = c("Full Model", "Reduced Model", "Further Reduced Model", "Stepwise Model", "Literature Model"),
  Adj_R_squared = c(summary(full_model)$adj.r.squared,
                    summary(reduced_model)$adj.r.squared,
                    summary(reduced_model2)$r.squared,
                    summary(stepwise_model)$adj.r.squared,
                    summary(literature_model)$adj.r.squared),
  AIC = c(AIC(full_model), AIC(reduced_model), AIC(reduced_model2),
          AIC(stepwise_model), AIC(literature_model)),
  BIC = c(BIC(full_model), BIC(reduced_model), BIC(reduced_model2),
          BIC(stepwise_model), BIC(literature_model)),
  Num_Predictors = c(length(coef(full_model)) - 1,
                     length(coef(reduced_model)) - 1,
                     length(coef(reduced_model2)) - 1,
                     length(coef(stepwise_model)) - 1,
                     length(coef(literature_model)) - 1)
)

<<<<<<< HEAD
kable(model_comparison, allign)

=======
graphic2<- kable(model_comparison, align=c("l","l","l","l","l"))
graphic2
>>>>>>> 3a66c6ff7af1ab9ab44b3a35913c569768ef8bc5

# 9. MODEL DIAGNOSTICS FOR BEST MODEL

# Choose best model based on comparison 
chosen_model <- reduced_model2  
print("The alternative model")

# 10. SUMMARY OUTPUT FOR REPORT


# Create summary table for key findings
key_findings <- data.frame(
  Finding = c(
    "Total Observations",
    "Number of Teams per Season",
    "Mean Winning Percentage",
    "Most Correlated Variable with WIN_PCT",
    "Least Correlated Variable with WIN_PCT",
    "Best Model R-squared",
    "Best Model Adjusted R-squared",
    "Number of Significant Predictors"
  ),
  Value = c(
    nrow(nba_data),
    "30",
    round(mean(nba_data$WIN_PCT), 3),
    names(which.max(abs(cor_mat[-14, "WIN_PCT"]))),
    names(which.min(abs(cor_mat[-14, "WIN_PCT"]))),
    round(summary(chosen_model)$r.squared, 4),
    round(summary(chosen_model)$adj.r.squared, 4),
    sum(summary(chosen_model)$coefficients[-1, 4] < 0.05)
  )
)


```


```{r}

# COLLINEARITY VISUALIZATION

# Method 1: Correlation Network Plot (shows only high correlations)
library(igraph)

# Create correlation matrix (exclude WIN_PCT)
cor_matrix <- cor(cor_vars[, -which(names(cor_vars) == "WIN_PCT")], use = "complete.obs")

# Set threshold for high correlation
threshold <- 0.80

# Create adjacency matrix for high correlations
cor_adj <- cor_matrix
cor_adj[abs(cor_adj) < threshold] <- 0
diag(cor_adj) <- 0

# Check if there are any high correlations to plot
if(sum(cor_adj != 0) > 0) {
  # Store the original signed values before taking absolute value
  cor_signed <- cor_adj
  
  # Create network graph - use ABSOLUTE values for weights
  graph <- graph_from_adjacency_matrix(abs(cor_adj),  
                                        mode = "undirected", 
                                        weighted = TRUE,
                                        diag = FALSE)
  
  # Get edge list and assign colors based on original correlation signs
  edge_list <- as_edgelist(graph)
  edge_colors <- sapply(1:nrow(edge_list), function(i) {
    val <- cor_signed[edge_list[i,1], edge_list[i,2]]
    ifelse(val > 0, "darkred", "darkblue")
  })
  
  # Plot network
  png("collinearity_network.png", width = 10, height = 10, units = "in", res = 300)
  set.seed(123)
  plot(graph,
       vertex.size = 20,
       vertex.color = "lightblue",
       vertex.label.color = "black",
       vertex.label.cex = 0.8,
       edge.width = E(graph)$weight * 5,
       edge.color = edge_colors,
       main = paste("Collinearity Network (|r| >", threshold, ")"),
       layout = layout_with_fr(graph))
  legend("bottomright", 
         legend = c("Positive correlation", "Negative correlation"),
         col = c("darkred", "darkblue"),
         lty = 1, lwd = 2, cex = 0.8)
  dev.off()
  print("Network plot saved as 'collinearity_network.png'")
} else {
  print(paste("No correlations above threshold of", threshold))
}


# Method 2: Clustered Correlation Heatmap
png("collinearity_clustered.png", width = 12, height = 10, units = "in", res = 300)
corrplot(cor_matrix, 
         method = "color", 
         type = "full",
         order = "hclust",  
         addrect = 4,       
         tl.col = "black", 
         tl.srt = 45,
         addCoef.col = "black", 
         number.cex = 0.6,
         title = "Clustered Correlation Matrix: Identifying Collinear Groups",
         mar = c(0,0,2,0))
dev.off()
print("Clustered heatmap saved as 'collinearity_clustered.png'")


# Method 3: VIF Bar Plot
vif_df <- data.frame(
  Variable = names(vif_values),
  VIF = as.numeric(vif_values)
)
vif_df <- vif_df %>% arrange(desc(VIF))

png("vif_barplot.png", width = 10, height = 6, units = "in", res = 300)
p_vif <- ggplot(vif_df, aes(x = reorder(Variable, VIF), y = VIF)) +
  geom_bar(stat = "identity", fill = ifelse(vif_df$VIF > 10, "red", "steelblue")) +
  geom_hline(yintercept = 10, linetype = "dashed", color = "red", linewidth = 1) +
  geom_hline(yintercept = 5, linetype = "dashed", color = "orange", linewidth = 1) +
  coord_flip() +
  labs(title = "Variance Inflation Factors (VIF)",
       subtitle = "Red bars indicate VIF > 10 (severe multicollinearity)",
       x = "Variable",
       y = "VIF Value") +
  theme_minimal() +
  theme(axis.text.y = element_text(size = 10))
print(p_vif)
dev.off()
print("VIF barplot saved as 'vif_barplot.png'")


# Method 4: Focused pairs plot for most problematic variables
high_vif_vars <- names(sort(vif_values, decreasing = TRUE)[1:8])

png("high_collinearity_pairs.png", width = 12, height = 12, units = "in", res = 300)
p_pairs <- ggpairs(nba_data[, high_vif_vars],
        title = "Top 8 Variables with Highest VIF: Pairwise Relationships",
        lower = list(continuous = wrap("points", alpha = 0.3, size = 0.5)),
        diag = list(continuous = wrap("densityDiag", alpha = 0.5)),
        upper = list(continuous = wrap("cor", size = 3))) +
  theme_minimal()
print(p_pairs)
dev.off()
print("Pairs plot saved as 'high_collinearity_pairs.png'")

print("All collinearity visualizations complete!")
```

```{r}
# VISUALIZATION: Variables Correlated with PTS

# Extract correlations with PTS
pts_correlations <- cor_mat[, "PTS"]
pts_correlations <- pts_correlations[names(pts_correlations) != "PTS"]  
pts_correlations <- pts_correlations[names(pts_correlations) != "WIN_PCT"]  
pts_correlations <- pts_correlations[names(pts_correlations) != "TRB"]
pts_correlations <- pts_correlations[names(pts_correlations) != "DRB"]
pts_correlations <- pts_correlations[names(pts_correlations) != "ORB"]
pts_correlations <- pts_correlations[names(pts_correlations) != "PF"]
pts_correlations <- pts_correlations[names(pts_correlations) != "STL"]
pts_correlations <- pts_correlations[names(pts_correlations) != "BLK"]
pts_correlations <- pts_correlations[names(pts_correlations) != "TOV"]
# Create data frame for plotting
pts_cor_df <- data.frame(
  Variable = names(pts_correlations),
  Correlation = as.numeric(pts_correlations)
)

# Bar plot of correlations with PTS

p4 <- ggplot(pts_cor_df, aes(x = reorder(Variable, Correlation), y = Correlation)) +
  geom_bar(stat = "identity", 
           fill = ifelse(pts_cor_df$Correlation > 0, "steelblue", "coral")) +
  geom_text(aes(label = round(Correlation, 3)), 
            hjust = ifelse(pts_cor_df$Correlation > 0, -0.1, 1.1), 
            size = 3) +
  coord_flip() +
  geom_hline(yintercept = 0, linetype = "solid", color = "black") +
  labs(title = "Correlation of All Variables with Points (PTS)",
       subtitle = "Positive correlations in blue, negative in coral",
       x = "Variable",
       y = "Correlation Coefficient") +
  theme_minimal() +
  theme(axis.text.y = element_text(size = 10),
        plot.caption = element_text(hjust = 0.5, size = 9, margin = margin(t = 10)))




```


```{r}
# Model without PF
NO_PF_model <- lm(formula = WIN_PCT ~ ORB + TRB + STL + TOV + PTS, data = nba_data)

anova(best_model, NO_PF_model)
```
